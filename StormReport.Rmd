---
title: "Public Health and Economic Impact of Severe Weather Events in the U.S."
author: "Amade Annissimo"
date: "November 18, 2015"
output: html_document
---

## Synopsis

## Data processing

### Dataset overview and variable selection

Dataset for the analysis comes from the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database.

The following commands have been used to load the dataset to a 'storm' data frame.
```{r, echo=TRUE, cache = TRUE}

stormDataFile <- "weather.rds"

if(!file.exists(stormDataFile)) {
    fileUrl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
    destFile <- "weather.csv.bz2"
    download.file(fileUrl, destfile = destFile, method = "curl")
    storm <- read.csv(destFile)
    saveRDS(storm,stormDataFile)
    }
storm <- readRDS(stormDataFile)
```

The data set consist of `r ncol(storm)` variables and `r format(nrow(storm), big.mark=",", scientific=FALSE)` observations.

```{r, echo=TRUE, cache = TRUE}
set.seed(100)
stormSample <- storm[sample(nrow(storm), 10000), ]
```


Variables which are not used in the analysis were removed from the dataset.

```{r, echo=TRUE}
library(plyr, warn.conflicts = FALSE) # 'plyr' package is used later in the analysis
library(dplyr, warn.conflicts = FALSE) # supress the messages on conflicst in variables
stormSample <- select(stormSample, -c(ZONENAMES, BGN_TIME, END_TIME, TIME_ZONE,
                                      STATE__, COUNTY, COUNTYNAME, BGN_RANGE,
                                      BGN_AZI, BGN_LOCATI, COUNTY_END, COUNTYENDN,
                                      END_RANGE, END_AZI, END_LOCATI, LENGTH,
                                      WIDTH, WFO, F, MAG, STATEOFFIC,
                                      LATITUDE, LONGITUDE, LATITUDE_E, LONGITUDE_)
                      )
```

### Variable cleanup and observation selection

#### Conversion of factor variables to character variables

For easier preprocessing, 'purrr' package has been used to convert factor to charater variables.

```{r, echo=TRUE}
library(purrr, warn.conflicts = FALSE) # supress the messages on conflicst in variables
stormSample %>% map_if(is.factor, as.character) -> stormSample
```

'REMARKS' variable has been stored in a separate data frame along with event's reference number and removed from the main dataset for easier processing.

```{r, echo=TRUE}
remarks <- data.frame(REFNUM = stormSample$REFNUM,REMARKS = stormSample$REMARKS)
stormSample <- select(stormSample, -REMARKS)
```

#### Conversion of 'date' variables to 'date' type

Date variables (BGN_DATE and END_DATE) were processed using the 'lubridate' package.

```{r, echo=TRUE}
library(lubridate, warn.conflicts = FALSE)
stormSample <- stormSample %>% mutate(
    BGN_DATE = as.Date(mdy_hms(stormSample$BGN_DATE)),
    END_DATE = as.Date(mdy_hms(stormSample$END_DATE))
    )
```

#### Exclusion of pre-1996 observations

The first event in the original dataset started on `r min(stormSample$BGN_DATE)` and last event finished on `r max(stormSample$BGN_DATE)`.

Observations before year 1996 have been excluded from the sample, as they do not contain information on all 48 weather event types tracked since that date. Previously only the data on tornado (since 1950), thunderstorm (since 1955), wind (since 1955) and hail (since 1955) events were recorded. More information on event type recording is availabilie on [NCDN website][1]. 
```{r, echo=TRUE}
removedObsCount <- sum(year(stormSample$BGN_DATE) < 1996) # Count of the observations remoded
removedObsPerc <- (sum(year(stormSample$BGN_DATE) < 1996)/
                       nrow(stormSample))*100 # Percentage share of the observations removed
stormSample <- stormSample[!(stormSample$BGN_DATE < 1996),]
```

As a result  of this procedure, `r format(removedObsCount, big.mark=",", scientific=FALSE)` observations (`r sprintf("%.1f %%", removedObsPerc)`) were removed from the sample. Have the observations not been removed, measurments of the global public health and economic impact of a particular event type would be underestimating the effects of events recorded only since 1996.

#### Rocoding variables measuring the monetary effects

Four variables measuring the magnitude of property (PROPDMG, PROPDMGEXP) and crop damages (CROPDMG, CROPDMGEXP)  have been recoded into two variables - PROPDMG and CROPDMG. In order to do that,  variables PROPDMGEXP and CROPDMGEXP have been cleaned up from values different than "K", "M" and "B" (ignoring case) and recoded to their numeric equivalents (representing thousands, millions and billions respectively). In the next step PROPDMG and CROPDMG variables have been multiplied by them.

```{r, echo=TRUE}
stormSample <- mutate(stormSample, PROPDMGEXP = toupper(PROPDMGEXP), CROPDMGEXP = toupper(CROPDMGEXP))
stormSample$PROPDMGEXP[!(stormSample$PROPDMGEXP %in% c("K", "M", "B"))] <- 1
stormSample$CROPDMGEXP[!(stormSample$CROPDMGEXP %in% c("K", "M", "B"))] <- 1

stormSample$PROPDMGEXP <- as.numeric(mapvalues(
    stormSample$PROPDMGEXP, from = c("K", "M", "B"), to = c(1000,1000000,1000000000)))
stormSample$CROPDMGEXP <- as.numeric(mapvalues(
    stormSample$CROPDMGEXP, from = c("K", "M", "B"), to = c(1000,1000000,1000000000)))

stormSample$PROPDMG <- (stormSample$PROPDMG * stormSample$PROPDMGEXP)
stormSample$CROPDMG <- (stormSample$CROPDMG * stormSample$CROPDMGEXP)

stormSample <- select(stormSample, -c(PROPDMGEXP, CROPDMGEXP))

options(scipen=999) # disable scientific notation
```

#### Recoding variables describing the event type

As mentioned previously, National Weather Service records 48 different types of weather events ([NCDC][1]). In the unprocessed form, *EVTYPE* vatiable, representing the event type has `r length(unique(stormSample$EVTYPE))` unique values.

```{r, echo=TRUE}
length(unique(stormSample$EVTYPE))
```

After conversion of all values of *EVTYPE* to upper case, number of unique event types decreased to `r length(unique(toupper(stormSample$EVTYPE)))`

```{r, echo=TRUE}
stormSample$EVTYPE <- toupper(stormSample$EVTYPE)
length(unique(stormSample$EVTYPE))
```

In the next processing step, naming convention of the event types has been unified by correcting 3 types of inconstintencies with the event types names specified in the [NWS Directive 10-1605][2]:

- abbreviations have been expanded (e.g. 'TSTM' to 'THUNDERSTORM')
- typhographical errors have been corrected (e.g. 'AVALANCE' to 'AVALANCHE')
- non-standard descriptions (i.e. different thatn in the NWS Directive 10-1605) have been standardized (e.g. 'FLOODING' to 'FLOOD')

### Mini data dictionary

Variables:

- *BGN_DATE* - represents the date when the event started
- *STATE* - represents the U.S. state or teritorry when the event took place

## Results

### Measuring public health impact

Measurment of the public health impact has been limited to measuring the number of injuries and deaths related to the weather event.

### Measuring economic impact

Measurment of the economic impact has been limited to measuring the crop and property damage in dollar terms.

  [1]: https://www.ncdc.noaa.gov/stormevents/details.jsp?type=eventtype        "NCDC"
  [2]: http://www.ncdc.noaa.gov/stormevents/pd01016005curr.pdf                 "NWS Directive 10-1605"